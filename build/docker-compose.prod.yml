version: "3.7"

services:
  db:
    container_name: db_document
    image: postgres:13.0-alpine
    volumes:
      - "./db:/var/lib/postgresql/data"
      - "../server:/server"
    environment:
      - POSTGRES_DB=document_repo
      - POSTGRES_USER=document_repo
      - POSTGRES_PASSWORD=document_repo
    ports:
      - "5432:5432"
    healthcheck:
      test: "exit 0"
    network_mode: host

  # adminer:
  #   container_name: file_adminer
  #   image: adminer
  #   ports:
  #     - "8080:8080"
  #   network_mode: host

  client:
    container_name: file_drive_client
    build:
      context: "../client"
      dockerfile: Dockerfile.client
    volumes:
      - "../client/src:/client/src"
    ports:
      - "3000:3000"

  backend:
    container_name: file_drive_backend
    build:
      context: "../server"
      dockerfile: Dockerfile.server
    volumes:
      - static_volume_server: "../server/staticfiles"
    # command: bash -c "python manage.py migrate && python manage.py initadmin"
    depends_on:
      - db
    ports:
      - "8000:8000"

  nginx:
    container_name: file_drive_nginx
    image: nginx:1.21-alpine
    tty: true
    volumes:
      - "../nginx/nginx.conf:/etc/nginx/nginx.conf"
    ports:
      - "80:80"
    depends_on:
      - server

volumes:
  static_volume_server:
  static_volume_client:
